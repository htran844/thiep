"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[283],{3104:(e,t,r)=>{r.d(t,{EU:()=>s,M9:()=>u,XB:()=>o,ZH:()=>c,mY:()=>a});var i=r(31335),n=r(49509);n.env.NEXT_PUBLIC_UMAMI_WEBSITE_ID,n.env.NEXT_PUBLIC_UMAMI_URL;let a=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"magic_link";(0,i.u4)("signup",{method:e})},o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"magic_link";(0,i.u4)("login",{method:e})},s=()=>{(0,i.u4)("template_viewed")},c=e=>{(0,i.u4)("invitation_published",{invitation_id:e})},u=e=>{(0,i.u4)("invitation_deleted",{was_published:e})}},4106:(e,t,r)=>{r.d(t,{o:()=>i});let i={track:(e,t)=>{if(window.ttq)try{window.ttq.track(e,t)}catch(e){console.error("TikTok Pixel tracking error:",e)}},trackCompleteRegistration:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;i.track("CompleteRegistration",{contents:[{content_id:"wedding_invitation_user",content_type:"product_group",content_name:"Wedding Invitation Registration"}],value:e,currency:"VND"})},trackStartTrial:(e,t)=>{i.track("StartTrial",{contents:[{content_id:e,content_type:"product",content_name:t?"Template ".concat(t):"Wedding Invitation"}],value:2e4,currency:"VND"})},trackPurchase:(e,t,r)=>{i.track("Purchase",{contents:[{content_id:t,content_type:"product",content_name:"Wedding Invitation Premium",content_category:"wedding_services"}],value:e,currency:"VND",description:r?"Discount: ".concat(r):void 0})},trackPlaceAnOrder:(e,t)=>{i.track("PlaceAnOrder",{contents:[{content_id:e,content_type:"product",content_name:t?"Template ".concat(t):"Wedding Invitation"}],value:2e4,currency:"VND"})},trackSubscribe:e=>{i.track("Subscribe",{contents:[{content_id:"newsletter_subscription",content_type:"product_group",content_name:"ChungDoi Updates"}],value:0,currency:"VND",description:e||"User subscribed to updates"})}}},23843:(e,t,r)=>{r.d(t,{$:()=>i});let i={get apiUrl(){return function(){let e="https://api.chungdoi.com";{let t=window.location.hostname;if("chungdoi.com"===t||"www.chungdoi.com"===t)return e;if(t.includes("ngrok")||/^(192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.|10\.)/.test(t))return"/backend-api"}return e}()},baseUrl:"https://chungdoi.com",googleMapsApiKey:"AIzaSyAY8WQxGig6axA_jZil94btO9G6dhsFEKg",gaId:"G-BQD5YB7KSP",nodeEnv:"production",isDevelopment:!1,isProduction:!0};i.isDevelopment&&console.log("Client Config:",{apiUrl:i.apiUrl,baseUrl:i.baseUrl,googleMapsApiKey:i.googleMapsApiKey?"***":"Not set",gaId:i.gaId?"***":"Not set"})},31335:(e,t,r)=>{r.d(t,{Fi:()=>l,MO:()=>g,c5:()=>a,do:()=>m,f0:()=>u,u4:()=>o,uN:()=>h});var i=r(72341);let n={};function a(e){n={...n,...e}}function o(e,t){let r={...n,...t};window.umami&&window.umami.track(e,r),window.gtag&&s&&window.gtag("event",e,r);try{i.Ay.capture(e,r)}catch(e){}}let s="G-BQD5YB7KSP",c=()=>!!(s&&window.gtag),u=(e,t)=>{o(e,t)},l=e=>{var t,r;c()&&(null==(t=(r=window).gtag)||t.call(r,"set","user_properties",e))},m=e=>{var t,r;c()&&(null==(t=(r=window).gtag)||t.call(r,"config",s,{user_id:null!=e?e:void 0}))},h=e=>{let t="string"==typeof e?new Date(e):e;return Math.ceil(Math.abs(new Date().getTime()-t.getTime())/864e5)},g=e=>"happy"===e.toLowerCase()?99:199},40283:(e,t,r)=>{r.d(t,{A:()=>d,AuthProvider:()=>g});var i=r(95155),n=r(12115),a=r(79323),o=r(31335),s=r(3104),c=r(90506),u=r(4106);async function l(e){if(!e)return;let t=(0,c.sH)(),r=e.referral_code;if(r)return void(0,c.ME)(r);if(t&&!r)try{await a.u.saveReferralCode(t)}catch(e){console.error("Failed to sync referral code to DB:",e)}}function m(e){if(null==e?void 0:e.utm_source)return void(0,o.c5)({utm_source:e.utm_source,utm_medium:e.utm_medium,utm_campaign:e.utm_campaign});let t=a.u.getUTMParams(),r={};t.utm_source&&(r.utm_source=t.utm_source),t.utm_medium&&(r.utm_medium=t.utm_medium),t.utm_campaign&&(r.utm_campaign=t.utm_campaign),Object.keys(r).length>0&&(0,o.c5)(r)}let h=(0,n.createContext)(void 0);function g(e){let{children:t}=e,[r,c]=(0,n.useState)(null),[g,d]=(0,n.useState)(!0);(0,n.useEffect)(()=>{(async()=>{try{m(null);let e=a.u.getUser();if(e&&a.u.isAuthenticated()){c(e);try{let e=await a.u.getCurrentUser();c(e),m(e)}catch(e){console.error("Token expired:",e),a.u.removeToken(),c(null)}}}catch(e){console.error("Failed to initialize auth:",e),a.u.removeToken(),c(null)}finally{d(!1)}})()},[]);let _=async e=>{try{let t=await a.u.login(e);t.user&&c(t.user)}catch(e){throw e}},p=async e=>{try{var t;await a.u.requestMagicLink(e);let r=(null==(t=e.email)?void 0:t.split("@")[1])||"unknown";(0,o.f0)("magic_link_requested",{email_domain:r})}catch(e){throw e}},f=async e=>{try{let t=await a.u.verifyMagicLink(e);c(t.user),t.isNewUser?((0,o.f0)("signup",{method:"magic_link"}),(0,s.mY)("magic_link"),u.o.trackCompleteRegistration()):((0,o.f0)("login",{method:"magic_link"}),(0,s.XB)("magic_link")),t.user&&((0,o.do)(t.user.id),(0,o.Fi)({user_role:t.user.role,user_type:"registered",email_verified:t.user.email_verified||!1,has_phone_number:!!t.user.phone_number}),m(t.user),l(t.user))}catch(e){throw e}},w=async e=>{try{let t=await a.u.verifyOTPCode(e);c(t.user);let r=t.isNewUser||!1;r?((0,o.f0)("signup",{method:"otp"}),(0,s.mY)("magic_link"),u.o.trackCompleteRegistration()):((0,o.f0)("login",{method:"otp"}),(0,s.XB)("magic_link")),(0,o.f0)("otp_verified",{method:"otp",is_new_user:r}),t.user&&((0,o.do)(t.user.id),(0,o.Fi)({user_role:t.user.role,user_type:"registered",email_verified:t.user.email_verified||!1,has_phone_number:!!t.user.phone_number}),m(t.user),l(t.user))}catch(e){throw e}},y=async e=>{try{await a.u.signup(e)}catch(e){throw e}},k=async()=>{try{(0,o.f0)("logout"),await a.u.logout(),c(null),(0,o.do)(null),(0,o.Fi)({user_type:"anonymous"})}catch(e){console.error("Logout failed:",e),c(null),(0,o.do)(null)}},v=e=>{if(r){let t={...r,...e};c(t),a.u.setUser(t)}},T=async()=>{try{let e=await a.u.getCurrentUser();return c(e),e}catch(e){return console.error("Failed to refresh user:",e),null}},E=async e=>{try{let t=await a.u.devLogin(e);c(t.user),(0,o.f0)("login",{method:"dev_login"}),(0,s.XB)("magic_link"),t.user&&((0,o.do)(t.user.id),(0,o.Fi)({user_role:t.user.role,user_type:"registered",email_verified:t.user.email_verified||!1,has_phone_number:!!t.user.phone_number}),m(t.user),l(t.user))}catch(e){throw e}},S=(0,n.useMemo)(()=>({user:r,loading:g,login:_,requestMagicLink:p,verifyMagicLink:f,verifyOTPCode:w,signup:y,logout:k,isAuthenticated:!!r,updateUser:v,refreshUser:T,devLogin:E}),[r,g]);return(0,i.jsx)(h.Provider,{value:S,children:t})}function d(){let e=(0,n.useContext)(h);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},79323:(e,t,r)=>{r.d(t,{u:()=>a});var i=r(23843);let n=()=>i.$.apiUrl;class a{static getUTMParams(){let e=sessionStorage.getItem(this.UTM_KEY);if(e)return JSON.parse(e);let t=new URLSearchParams(window.location.search),r={};return t.get("utm_source")&&(r.utm_source=t.get("utm_source")),t.get("utm_medium")&&(r.utm_medium=t.get("utm_medium")),t.get("utm_campaign")&&(r.utm_campaign=t.get("utm_campaign")),t.get("utm_content")&&(r.utm_content=t.get("utm_content")),t.get("utm_term")&&(r.utm_term=t.get("utm_term")),t.get("fbclid")&&(r.fbclid=t.get("fbclid")),t.get("gclid")&&(r.gclid=t.get("gclid")),r.utm_source||r.fbclid||r.gclid||!document.referrer||(r.referrer=document.referrer),Object.keys(r).length>0&&sessionStorage.setItem(this.UTM_KEY,JSON.stringify(r)),r}static clearUTMParams(){sessionStorage.removeItem(this.UTM_KEY)}static getToken(){return localStorage.getItem(this.TOKEN_KEY)}static setToken(e){localStorage.setItem(this.TOKEN_KEY,e)}static removeToken(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)}static getUser(){let e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}static setUser(e){localStorage.setItem(this.USER_KEY,JSON.stringify(e))}static isAuthenticated(){return!!this.getToken()}static async login(e){return this.requestMagicLink({email:e.email})}static async requestMagicLink(e){let t=this.getUTMParams(),r={...e,...t},i=await fetch("".concat(n(),"/api/auth/request-magic-link"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok)throw Error((await i.json()).error||"Kh\xf4ng thể gửi email. Vui l\xf2ng thử lại.");return{message:(await i.json()).message,user:null,token:""}}static async verifyMagicLink(e){let t=await fetch("".concat(n(),"/api/auth/verify-magic-link"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!t.ok)throw Error((await t.json()).error||"Link kh\xf4ng hợp lệ hoặc đ\xe3 hết hạn.");let r=await t.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async verifyOTPCode(e){let t=await fetch("".concat(n(),"/api/auth/verify-code"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error((await t.json()).error||"M\xe3 kh\xf4ng hợp lệ hoặc đ\xe3 hết hạn.");let r=await t.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async signup(e){let t=this.getUTMParams(),r=await fetch("".concat(n(),"/api/auth/signup"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.name,email:e.email,...t})});if(!r.ok)throw Error((await r.json()).error||"Đăng k\xfd thất bại. Vui l\xf2ng thử lại sau.");let i=await r.json();return{message:i.message,user:i.user||null,token:""}}static async logout(){let e=this.getToken();if(e)try{await fetch("".concat(n(),"/api/auth/logout"),{method:"POST",headers:{Authorization:"Bearer ".concat(e)}})}catch(e){console.error("Logout API call failed:",e)}this.removeToken()}static async getCurrentUser(){let e=this.getToken();if(!e)throw Error("Chưa đăng nhập. Vui l\xf2ng đăng nhập để tiếp tục.");let t=await fetch("".concat(n(),"/api/auth/me"),{headers:{Authorization:"Bearer ".concat(e)}});if(!t.ok){if(401===t.status)throw this.removeToken(),Error("Ph\xean đăng nhập đ\xe3 hết hạn. Vui l\xf2ng đăng nhập lại.");throw Error("Kh\xf4ng thể tải th\xf4ng tin t\xe0i khoản. Vui l\xf2ng thử lại.")}let r=await t.json();return r.user&&this.setUser(r.user),r.user}static async authenticatedFetch(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getToken();if(!r)throw Error("Chưa đăng nhập. Vui l\xf2ng đăng nhập để tiếp tục.");let i={...t.headers,Authorization:"Bearer ".concat(r)},n=await fetch(e,{...t,headers:i});if(401===n.status)throw this.removeToken(),Error("Authentication expired");return n}static async devLogin(e){let t=await fetch("".concat(n(),"/api/auth/dev-login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok)throw Error((await t.json()).error||"Dev login failed");let r=await t.json();return this.setToken(r.token),r.user&&this.setUser(r.user),r}static async getDevLoginUsers(e){let t=new URL("".concat(n(),"/api/auth/dev-login/users"));e&&e.length>=2&&t.searchParams.set("search",e);let r=await fetch(t.toString(),{method:"GET"});if(!r.ok)throw Error((await r.json()).error||"Failed to fetch users");return(await r.json()).users}static async saveReferralCode(e){let t=this.getToken();if(!t)throw Error("Chưa đăng nhập");let r=await fetch("".concat(n(),"/api/auth/referral-code"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify({referral_code:e})});if(!r.ok)throw Error((await r.json()).error||"Kh\xf4ng thể lưu m\xe3 giảm gi\xe1");return r.json()}static isAdmin(e){return(null==e?void 0:e.role)==="admin"||(null==e?void 0:e.role)==="super_admin"}static isSuperAdmin(e){return(null==e?void 0:e.role)==="super_admin"}static hasAdminAccess(e){return this.isAdmin(e)}}a.TOKEN_KEY="auth_token",a.USER_KEY="auth_user",a.UTM_KEY="utm_params"},90506:(e,t,r)=>{r.d(t,{$g:()=>s,ME:()=>c,T_:()=>o,YL:()=>n,iB:()=>i,sH:()=>u});let i=[{tier:1,name:"Bronze",minReferrals:0,maxReferrals:4,commissionPercent:10},{tier:2,name:"Silver",minReferrals:5,maxReferrals:14,commissionPercent:20},{tier:3,name:"Gold",minReferrals:15,maxReferrals:1/0,commissionPercent:30}],n=20,a={STORAGE_KEY:"chungdoi_ref"};function o(e){var t;let r=(t=e,i.find(e=>t>=e.minReferrals&&t<=e.maxReferrals)||i[0]),n=i.find(e=>e.tier===r.tier+1);return n?n.minReferrals-e:null}function s(e){return e.toLocaleString("vi-VN")}function c(e){localStorage.setItem(a.STORAGE_KEY,e.toUpperCase())}function u(){return localStorage.getItem(a.STORAGE_KEY)}}}]);